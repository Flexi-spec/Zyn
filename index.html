<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok Real-Time Feed</title>

<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #000;
    overflow: hidden;
  }

  #feed {
    height: 100vh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
  }

  .post {
    height: 100vh;
    scroll-snap-align: start;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #000;
  }

  video, img {
    max-height: 100vh;
    width: 100%;
    object-fit: cover;
  }

  /* Floating action bar */
  .side-buttons {
    position: absolute;
    right: 20px;
    bottom: 140px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .icon-btn {
    color: #fff;
    font-size: 28px;
    text-align: center;
    cursor: pointer;
    backdrop-filter: blur(4px);
    background: rgba(255,255,255,0.15);
    padding: 14px;
    border-radius: 50%;
    transition: 0.2s;
  }

  .icon-btn:hover {
    transform: scale(1.1);
  }

  /* COMMENTS POPUP */
  #commentPopup {
    position: fixed;
    left: 0;
    bottom: -100%;
    width: 100%;
    height: 60%;
    background: rgba(0,0,0,0.92);
    backdrop-filter: blur(6px);
    color: #fff;
    padding: 20px;
    transition: 0.4s ease-out;
    display: flex;
    flex-direction: column;
    z-index: 20;
  }

  #commentsList {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 20px;
  }

  .comment {
    padding: 10px 0;
    border-bottom: 1px solid #333;
    font-size: 15px;
  }

  #commentInput {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    outline: none;
  }

  /* UPLOAD BUTTON */
  #uploadBtn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    color: #fff;
    background: rgba(255,255,255,0.2);
    padding: 12px 18px;
    border-radius: 30px;
    cursor: pointer;
    backdrop-filter: blur(6px);
  }
</style>
</head>

<body>

<div id="feed"></div>

<!-- Upload nav -->
<div id="uploadBtn" onclick="window.location='update.html'">Upload</div>

<!-- Comment popup -->
<div id="commentPopup">
  <h3>Comments</h3>
  <div id="commentsList"></div>
  <input id="commentInput" placeholder="Add a comment...">
</div>

<script>
  // Init Ably
  var ably = new Ably.Realtime('n71aDg.Orkzww:R1GM_0-1pINgPGPiP5qeBSb7UiPT2VKNLXRRgB5xCAo');
var channel = ably.channels.get('channel1');

// Publish a message to the channel1 channel

  let currentPost = null;

  // Listen for new posts
  channel.subscribe("new_post", msg => {
    addPost(msg.data);
  });

  // Listen for likes
  channel.subscribe("like", msg => {
    updateLikes(msg.data.src);
  });

  // Listen for comments
  channel.subscribe("comment", msg => {
    if (currentPost === msg.data.src) {
      addCommentElement(msg.data.comment);
    }
  });

  // Add post to feed
  function addPost(data) {
    let feed = document.getElementById("feed");

    let post = document.createElement("div");
    post.className = "post";

    let media;

    if (data.type === "video") {
      media = document.createElement("video");
      media.src = data.src;
      media.autoplay = true;
      media.loop = true;
      media.muted = true;
    } else {
      media = document.createElement("img");
      media.src = data.src;
    }

    /* Floating buttons */
    let side = document.createElement("div");
    side.className = "side-buttons";

    let likeBtn = document.createElement("div");
    likeBtn.className = "icon-btn";
    likeBtn.innerHTML = "â¤ï¸";
    likeBtn.onclick = () => channel.publish("like", { src: data.src });

    let commentBtn = document.createElement("div");
    commentBtn.className = "icon-btn";
    commentBtn.innerHTML = "ðŸ’¬";
    commentBtn.onclick = () => openComments(data.src);

    side.appendChild(likeBtn);
    side.appendChild(commentBtn);

    post.appendChild(media);
    post.appendChild(side);
    feed.prepend(post);
  }

  function updateLikes(src) {
    document.querySelectorAll("video,img").forEach(el => {
      if (el.src === src) {
        let likeBtn = el.parentElement.querySelector(".icon-btn");
        likeBtn.innerHTML = "â¤ï¸";
      }
    });
  }

  /* COMMENTS */
  function openComments(src) {
    currentPost = src;
    document.getElementById("commentsList").innerHTML = "";
    document.getElementById("commentPopup").style.bottom = "0";

    // Load old comments from Ably history (optional)
  }

  document.getElementById("commentInput").addEventListener("keydown", e => {
    if (e.key === "Enter") {
      let text = e.target.value.trim();
      if (text.length > 0) {
        channel.publish("comment", { src: currentPost, comment: text });
        e.target.value = "";
      }
    }
  });

  function addCommentElement(text) {
    let c = document.createElement("div");
    c.className = "comment";
    c.textContent = text;
    document.getElementById("commentsList").appendChild(c);
  }
</script>

</body>
</html>
